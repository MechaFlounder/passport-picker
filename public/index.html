<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passport Picker - Visa-Free Travel Map</title>
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css' rel='stylesheet' />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        #loader {
            transition: opacity 0.5s ease-out;
        }
        /* Mapbox Attribution Control - Keep it visible */
        .mapboxgl-ctrl-bottom-left, .mapboxgl-ctrl-bottom-right {
            z-index: 10;
        }
        /* Styles for the view toggle */
        .toggle-btn.active {
            background-color: #3B82F6;
            color: white;
        }
        .toggle-btn {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        /* Styles for new flag selector */
        .flag-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .flag-item:hover {
            transform: scale(1.05);
        }
        .flag-item.selected {
            box-shadow: 0 0 0 4px #3B82F6;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-[100]" style="display: none; opacity: 0;">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loader-text" class="mt-4 text-lg text-gray-700 font-medium">Initializing...</p>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landing-page" class="h-screen w-screen flex flex-col items-center bg-gray-100 p-4 transition-opacity duration-500">
        <div class="text-center max-w-4xl w-full flex flex-col h-full">
            <header class="py-4 flex-shrink-0">
                <h1 class="text-5xl md:text-6xl font-bold text-gray-900">Passport Picker</h1>
                <p class="text-xl text-gray-600 mt-4">Select your passports. The first one you pick will win tiebreaks.</p>
            </header>
            <div class="my-6 flex-shrink-0">
                <button id="view-map-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    View Map
                </button>
            </div>
            <div class="w-full max-w-lg mx-auto mb-4 flex-shrink-0">
                <input type="text" id="country-search" placeholder="Search for a country..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div id="flag-grid" class="flex-grow overflow-y-auto grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4 p-4 bg-white rounded-lg shadow-inner w-full">
                <!-- Flags will be generated here -->
            </div>
            <div id="selected-passports-tray" class="w-full max-w-4xl mt-auto pt-4 flex-shrink-0">
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2 text-left">Your Passports:</h3>
                    <div id="selected-flags-container" class="flex items-center gap-3 h-12 overflow-x-auto">
                        <span id="tray-placeholder" class="text-gray-500">Select a passport to begin</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map View -->
    <div id="map-view" class="h-screen w-screen absolute top-0 left-0 opacity-0 pointer-events-none transition-opacity duration-500">
        <div id="map-container" class="w-full h-full"></div>
        
        <!-- Back Button -->
        <div class="absolute top-4 left-4 z-10">
            <button id="back-to-landing-btn" class="bg-white bg-opacity-90 backdrop-blur-sm rounded-full shadow-lg p-2 hover:bg-gray-200 transition-colors pointer-events-auto">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
        </div>

        <!-- View Toggle -->
        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-10">
            <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-full shadow-lg p-1 flex pointer-events-auto">
                <button id="visa-view-btn" class="toggle-btn active text-sm font-semibold py-2 px-6 rounded-full">Visa Status</button>
                <button id="passport-view-btn" class="toggle-btn text-sm font-semibold py-2 px-6 rounded-full">Best Passport</button>
            </div>
        </div>

        <!-- Overlays Container -->
        <div class="absolute bottom-0 left-0 right-0 p-2 md:p-4 pointer-events-none">
            <div class="flex flex-col-reverse md:flex-row md:justify-between md:items-end gap-4">
                <!-- Selected Passports (Left) -->
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-xl shadow-lg p-3 pointer-events-auto self-start md:self-auto">
                    <div id="map-selected-flags" class="flex items-center gap-2 flex-wrap"></div>
                </div>
                <!-- Legend (Right) -->
                <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-xl shadow-lg p-2 pointer-events-auto">
                    <div id="visa-status-legend" class="flex flex-wrap justify-center gap-x-3 gap-y-1"></div>
                    <div id="best-passport-legend" class="hidden flex-wrap justify-center gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Tooltip -->
    <div id="tooltip" class="absolute bg-white text-sm rounded-lg shadow-xl p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300 max-w-xs">
        <h3 id="tooltip-country" class="font-bold text-lg mb-2"></h3>
        <div id="tooltip-content"></div>
    </div>

    <script>
        // --- UI ELEMENTS ---
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const landingPage = document.getElementById('landing-page');
        const mapView = document.getElementById('map-view');
        const viewMapBtn = document.getElementById('view-map-btn');
        const backToLandingBtn = document.getElementById('back-to-landing-btn');
        const tooltip = document.getElementById('tooltip');
        const tooltipCountry = document.getElementById('tooltip-country');
        const tooltipContent = document.getElementById('tooltip-content');
        const visaViewBtn = document.getElementById('visa-view-btn');
        const passportViewBtn = document.getElementById('passport-view-btn');
        const visaStatusLegend = document.getElementById('visa-status-legend');
        const bestPassportLegend = document.getElementById('best-passport-legend');
        const flagGrid = document.getElementById('flag-grid');
        const countrySearch = document.getElementById('country-search');
        const selectedFlagsContainer = document.getElementById('selected-flags-container');
        const mapSelectedFlags = document.getElementById('map-selected-flags');
        const trayPlaceholder = document.getElementById('tray-placeholder');
        
        let allVisaData = {};
        let currentView = 'visa';
        let sessionPassportColors = {};
        let selectedPassports = [];
        let map; // Mapbox map object
        let hoveredCountryId = null; // To track hovered country
        const fallbackColors = ['#E6194B', '#FFE119', '#F58231', '#911EB4', '#46F0F0', '#F032E6', '#BCF60C', '#FABEBE', '#008080', '#E6BEFF'];

        // --- DATA MAPPING & PRIORITIES ---
        const statusPriority = { "citizen": 0, "fom": 1, "permit": 2, "vf": 3, "esta": 4, "eta": 4, "ev": 4, "voa": 5, "vr": 6, "denied": 7, "na": 8 };
        const statusText = { "citizen": "Citizen", "fom": "Freedom of Movement", "permit": "Travel Permit Required", "vf": "Visa Not Required", "voa": "Visa on Arrival", "esta": "ESTA", "eta": "eTA", "ev": "e-Visa / Online", "vr": "Visa Required", "denied": "Not Admitted", "na": "No Data" };
        const statusColors = { "citizen": "#8E44AD", "fom": "#1ABC9C", "permit": "#3498DB", "vf": "#4CAF50", "voa": "#FFC107", "esta": "#2196F3", "eta": "#2196F3", "ev": "#2196F3", "vr": "#F44336", "denied": "#5D4037", "na": "#BDBDBD" };
        
        const countryColorPalette = { 'US': { primary: '#0A3161', secondary: '#B31942' }, 'GB': { primary: '#CF142B', secondary: '#00247D' }, 'CA': { primary: '#FF0000', secondary: '#FFFFFF' }, 'AU': { primary: '#00008B', secondary: '#FFCD00' }, 'NZ': { primary: '#00247D', secondary: '#CF142B' }, 'DE': { primary: '#000000', secondary: '#FFCE00' }, 'FR': { primary: '#0055A4', secondary: '#EF4135' }, 'IT': { primary: '#009246', secondary: '#CE2B37' }, 'ES': { primary: '#C60B1E', secondary: '#FFC400' }, 'JP': { primary: '#BC002D', secondary: '#FFFFFF' }, 'CN': { primary: '#EE1C25', secondary: '#FFFF00' }, 'IN': { primary: '#FF9933', secondary: '#138808' }, 'BR': { primary: '#009B3A', secondary: '#FFDF00' }, 'RU': { primary: '#D52B1E', secondary: '#0039A6' }, 'ZA': { primary: '#007A4D', secondary: '#FFB612' }, 'IE': { primary: '#169B62', secondary: '#FF883E' }, 'CH': { primary: '#FF0000', secondary: '#FFFFFF' }, 'SE': { primary: '#006AA7', secondary: '#FFCD00' }, 'NO': { primary: '#EF2B2D', secondary: '#002868' }, 'KR': { primary: '#CD2E3A', secondary: '#0047A0' } };
        const countryAliases = { "US": ["usa", "america", "united states"], "GB": ["uk", "great britain", "england", "scotland", "wales", "britain"], "AE": ["uae"], "KR": ["south korea", "republic of korea"], "KP": ["north korea"], "RU": ["russia"], "CZ": ["czechia"], "CD": ["drc", "congo dem. rep."], "CG": ["congo"], "BS": ["the bahamas"], "DO": ["dr", "dominican rep."], "CF": ["car", "central african rep."], "ZA": ["sa"], "NZ": ["new zeland"] };
        const apiPassportList = { "Afghanistan": "AF", "Albania": "AL", "Algeria": "DZ", "Andorra": "AD", "Angola": "AO", "Antigua and Barbuda": "AG", "Argentina": "AR", "Armenia": "AM", "Australia": "AU", "Austria": "AT", "Azerbaijan": "AZ", "Bahamas": "BS", "Bahrain": "BH", "Bangladesh": "BD", "Barbados": "BB", "Belarus": "BY", "Belgium": "BE", "Belize": "BZ", "Benin": "BJ", "Bhutan": "BT", "Bolivia": "BO", "Bosnia and Herzegovina": "BA", "Botswana": "BW", "Brazil": "BR", "Brunei": "BN", "Bulgaria": "BG", "Burkina Faso": "BF", "Burundi": "BI", "Cambodia": "KH", "Cameroon": "CM", "Canada": "CA", "Cape Verde": "CV", "Central African Republic": "CF", "Chad": "TD", "Chile": "CL", "China": "CN", "Colombia": "CO", "Comoros": "KM", "Congo": "CG", "Congo (Dem. Rep.)": "CD", "Costa Rica": "CR", "Cote d'Ivoire": "CI", "Croatia": "HR", "Cuba": "CU", "Cyprus": "CY", "Czech Republic": "CZ", "Denmark": "DK", "Djibouti": "DJ", "Dominica": "DM", "Dominican Republic": "DO", "Ecuador": "EC", "Egypt": "EG", "El Salvador": "SV", "Equatorial Guinea": "GQ", "Eritrea": "ER", "Estonia": "EE", "Eswatini": "SZ", "Ethiopia": "ET", "Fiji": "FJ", "Finland": "FI", "France": "FR", "Gabon": "GA", "Gambia": "GM", "Georgia": "GE", "Germany": "DE", "Ghana": "GH", "Greece": "GR", "Grenada": "GD", "Guatemala": "GT", "Guinea": "GN", "Guinea-Bissau": "GW", "Guyana": "GY", "Haiti": "HT", "Honduras": "HN", "Hong Kong": "HK", "Hungary": "HU", "Iceland": "IS", "India": "IN", "Indonesia": "ID", "Iran": "IR", "Iraq": "IQ", "Ireland": "IE", "Israel": "IL", "Italy": "IT", "Jamaica": "JM", "Japan": "JP", "Jordan": "JO", "Kazakhstan": "KZ", "Kenya": "KE", "Kiribati": "KI", "Kosovo": "XK", "Kuwait": "KW", "Kyrgyzstan": "KG", "Laos": "LA", "Latvia": "LV", "Lebanon": "LB", "Lesotho": "LS", "Liberia": "LR", "Libya": "LY", "Liechtenstein": "LI", "Lithuania": "LT", "Luxembourg": "LU", "Macau": "MO", "Madagascar": "MG", "Malawi": "MW", "Malaysia": "MY", "Maldives": "MV", "Mali": "ML", "Malta": "MT", "Marshall Islands": "MH", "Mauritania": "MR", "Mauritius": "MU", "Mexico": "MX", "Micronesia": "FM", "Moldova": "MD", "Monaco": "MC", "Mongolia": "MN", "Montenegro": "ME", "Morocco": "MA", "Mozambique": "MZ", "Myanmar": "MM", "Namibia": "NA", "Nauru": "NR", "Nepal": "NP", "Netherlands": "NL", "New Zealand": "NZ", "Nicaragua": "NI", "Niger": "NE", "Nigeria": "NG", "North Korea": "KP", "North Macedonia": "MK", "Norway": "NO", "Oman": "OM", "Pakistan": "PK", "Palau": "PW", "Palestinian Territories": "PS", "Panama": "PA", "Papua New Guinea": "PG", "Paraguay": "PY", "Peru": "PE", "Philippines": "PH", "Poland": "PL", "Portugal": "PT", "Qatar": "QA", "Romania": "RO", "Russian Federation": "RU", "Rwanda": "RW", "Saint Kitts and Nevis": "KN", "Saint Lucia": "LC", "Samoa": "WS", "San Marino": "SM", "Sao Tome and Principe": "ST", "Saudi Arabia": "SA", "Senegal": "SN", "Serbia": "RS", "Seychelles": "SC", "Sierra Leone": "SL", "Singapore": "SG", "Slovakia": "SK", "Slovenia": "SI", "Solomon Islands": "SB", "Somalia": "SO", "South Africa": "ZA", "South Korea": "KR", "South Sudan": "SS", "Spain": "ES", "Sri Lanka": "LK", "St. Vincent and the Grenadines": "VC", "Sudan": "SD", "Suriname": "SR", "Sweden": "SE", "Switzerland": "CH", "Syria": "SY", "Taiwan": "TW", "Tajikistan": "TJ", "Tanzania": "TZ", "Thailand": "TH", "Timor-Leste": "TL", "Togo": "TG", "Tonga": "TO", "Trinidad and Tobago": "TT", "Tunisia": "TN", "Türkiye": "TR", "Turkmenistan": "TM", "Tuvalu": "TV", "Uganda": "UG", "Ukraine": "UA", "United Arab Emirates": "AE", "United Kingdom": "GB", "United States of America": "US", "Uruguay": "UY", "Uzbekistan": "UZ", "Vanuatu": "VU", "Vatican City": "VA", "Venezuela": "VE", "Viet Nam": "VN", "Yemen": "YE", "Zambia": "ZM", "Zimbabwe": "ZW" };
        const countryNameToCodeMap = { "Afghanistan": "AF", "Angola": "AO", "Albania": "AL", "United Arab Emirates": "AE", "Argentina": "AR", "Armenia": "AM", "Antarctica": "AQ", "Fr. S. and Antarctic Lands": "TF", "Australia": "AU", "Austria": "AT", "Azerbaijan": "AZ", "Burundi": "BI", "Belgium": "BE", "Benin": "BJ", "Burkina Faso": "BF", "Bangladesh": "BD", "Bulgaria": "BG", "Bahamas": "BS", "Bosnia and Herz.": "BA", "Belarus": "BY", "Belize": "BZ", "Bermuda": "BM", "Bolivia": "BO", "Brazil": "BR", "Brunei": "BN", "Bhutan": "BT", "Botswana": "BW", "Central African Rep.": "CF", "Canada": "CA", "Switzerland": "CH", "Chile": "CL", "China": "CN", "Ivory Coast": "CI", "Côte d'Ivoire": "CI", "Cameroon": "CM", "Dem. Rep. Congo": "CD", "Congo": "CG", "Colombia": "CO", "Costa Rica": "CR", "Cuba": "CU", "N. Cyprus": "CY", "Cyprus": "CY", "Czechia": "CZ", "Germany": "DE", "Djibouti": "DJ", "Denmark": "DK", "Dominican Rep.": "DO", "Algeria": "DZ", "Ecuador": "EC", "Egypt": "EG", "Eritrea": "ER", "Spain": "ES", "Estonia": "EE", "eSwatini": "SZ", "Ethiopia": "ET", "Finland": "FI", "Fiji": "FJ", "Falkland Is.": "FK", "France": "FR", "Gabon": "GA", "United Kingdom": "GB", "Georgia": "GE", "Ghana": "GH", "Guinea": "GN", "Gambia": "GM", "Guinea-Bissau": "GW", "Eq. Guinea": "GQ", "Greece": "GR", "Greenland": "GL", "Guatemala": "GT", "Fr. Guiana": "GF", "Guyana": "GY", "Honduras": "HN", "Croatia": "HR", "Haiti": "HT", "Hungary": "HU", "Indonesia": "ID", "India": "IN", "Ireland": "IE", "Iran": "IR", "Iraq": "IQ", "Iceland": "IS", "Israel": "IL", "Italy": "IT", "Jamaica": "JM", "Jordan": "JO", "Japan": "JP", "Kazakhstan": "KZ", "Kenya": "KE", "Kyrgyzstan": "KG", "Cambodia": "KH", "South Korea": "KR", "Kosovo": "XK", "Kuwait": "KW", "Laos": "LA", "Lebanon": "LB", "Liberia": "LR", "Libya": "LY", "Sri Lanka": "LK", "Lesotho": "LS", "Lithuania": "LT", "Luxembourg": "LU", "Latvia": "LV", "Morocco": "MA", "Moldova": "MD", "Madagascar": "MG", "Mexico": "MX", "Macedonia": "MK", "North Macedonia": "MK", "Mali": "ML", "Malta": "MT", "Myanmar": "MM", "Montenegro": "ME", "Mongolia": "MN", "Mozambique": "MZ", "Mauritania": "MR", "Malawi": "MW", "Malaysia": "MY", "Namibia": "NA", "New Caledonia": "NC", "Niger": "NE", "Nigeria": "NG", "Nicaragua": "NI", "Netherlands": "NL", "Norway": "NO", "Nepal": "NP", "New Zealand": "NZ", "Oman": "OM", "Pakistan": "PK", "Panama": "PA", "Peru": "PE", "Philippines": "PH", "Papua New Guinea": "PG", "Poland": "PL", "Puerto Rico": "PR", "North Korea": "KP", "Portugal": "PT", "Paraguay": "PY", "Qatar": "QA", "Romania": "RO", "Russia": "RU", "Rwanda": "RW", "W. Sahara": "EH", "Saudi Arabia": "SA", "Sudan": "SD", "S. Sudan": "SS", "Senegal": "SN", "Solomon Is.": "SB", "Solomon Islands": "SB", "Sierra Leone": "SL", "El Salvador": "SV", "Somaliland": "SO", "Somalia": "SO", "Serbia": "RS", "Suriname": "SR", "Slovakia": "SK", "Slovenia": "SI", "Sweden": "SE", "Swaziland": "SZ", "Eswatini": "SZ", "Syria": "SY", "Chad": "TD", "Togo": "TG", "Thailand": "TH", "Tajikistan": "TJ", "Turkmenistan": "TM", "Timor-Leste": "TL", "Trinidad and Tobago": "TT", "Tunisia": "TN", "Turkey": "TR", "Taiwan": "TW", "Tanzania": "TZ", "Uganda": "UG", "Ukraine": "UA", "Uruguay": "UY", "United States of America": "US", "Uzbekistan": "UZ", "Venezuela": "VE", "Vietnam": "VN", "Vanuatu": "VU", "Yemen": "YE", "South Africa": "ZA", "Zambia": "ZM", "Zimbabwe": "ZW" };
        function getCountryCodeFromName(name) { return countryNameToCodeMap[name] || null; }
        const countryCodeToNameMap = {};
        for (const name in apiPassportList) { countryCodeToNameMap[apiPassportList[name]] = name; }

        // --- CORE LOGIC ---
        const colorConverter = { isColorTooSimilar(hex1, hex2, threshold = 20) { if (!hex1 || !hex2) return false; if (hex1 === '#FFFFFF' && hex2 === '#FFFFFF') return true; const hexToRgb = (hex) => { let r = 0, g = 0, b = 0; if (hex.length == 4) { r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3]; } else if (hex.length == 7) { r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6]; } return { r: +r, g: +g, b: +b }; }; const rgbToXyz = ({ r, g, b }) => { r /= 255; g /= 255; b /= 255; r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92; g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92; b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92; r *= 100; g *= 100; b *= 100; return { x: r * 0.4124 + g * 0.3576 + b * 0.1805, y: r * 0.2126 + g * 0.7152 + b * 0.0722, z: r * 0.0193 + g * 0.1192 + b * 0.9505 }; }; const xyzToLab = ({ x, y, z }) => { x /= 95.047; y /= 100; z /= 108.883; x = x > 0.008856 ? Math.pow(x, 1 / 3) : (7.787 * x) + (16 / 116); y = y > 0.008856 ? Math.pow(y, 1 / 3) : (7.787 * y) + (16 / 116); z = z > 0.008856 ? Math.pow(z, 1 / 3) : (7.787 * z) + (16 / 116); return { l: (116 * y) - 16, a: 500 * (x - y), b: 200 * (y - z) }; }; const deltaE = (labA, labB) => { const deltaL = labA.l - labB.l; const deltaA = labA.a - labB.a; const deltaB = labA.b - labB.b; const c1 = Math.sqrt(labA.a * labA.a + labA.b * labA.b); const c2 = Math.sqrt(labB.a * labB.a + labB.b * labB.b); const deltaC = c1 - c2; let deltaH = deltaA * deltaA + deltaB * deltaB - deltaC * deltaC; deltaH = deltaH < 0 ? 0 : Math.sqrt(deltaH); const sc = 1.0 + 0.045 * c1; const sh = 1.0 + 0.015 * c1; const i = (deltaL / 1.0) ** 2 + (deltaC / sc) ** 2 + (deltaH / sh) ** 2; return i < 0 ? 0 : Math.sqrt(i); }; const lab1 = xyzToLab(rgbToXyz(hexToRgb(hex1))); const lab2 = xyzToLab(rgbToXyz(hexToRgb(hex2))); return deltaE(lab1, lab2) < threshold; } };
        function assignPassportColors(passports) { const assignedColors = {}; const usedColors = []; let fallbackIndex = 0; passports.forEach(passportCode => { const palette = countryColorPalette[passportCode]; let colorToAssign = null; if (palette && palette.primary) { if (!usedColors.some(usedColor => colorConverter.isColorTooSimilar(palette.primary, usedColor))) { colorToAssign = palette.primary; } } if (!colorToAssign && palette && palette.secondary) { if (!usedColors.some(usedColor => colorConverter.isColorTooSimilar(palette.secondary, usedColor))) { colorToAssign = palette.secondary; } } if (!colorToAssign) { do { colorToAssign = fallbackColors[fallbackIndex % fallbackColors.length]; fallbackIndex++; } while (usedColors.some(usedColor => colorConverter.isColorTooSimilar(colorToAssign, usedColor))); } assignedColors[passportCode] = colorToAssign; usedColors.push(colorToAssign); }); return assignedColors; }
        function getVisaStatusFromString(visaInfo) { if (!visaInfo) return 'na'; const lowerVisaInfo = visaInfo.toLowerCase(); if (lowerVisaInfo.includes('freedom of movement')) return 'fom'; if (lowerVisaInfo.includes('visa not required')) return 'vf'; if (lowerVisaInfo.includes('visa on arrival') || lowerVisaInfo.includes('e-voa') || lowerVisaInfo.includes('entry permit on arrival') || lowerVisaInfo.includes('free visa on arrival')) return 'voa'; if (lowerVisaInfo.includes('esta')) return 'esta'; if (lowerVisaInfo.includes('eta') || lowerVisaInfo.includes('evisitor')) return 'eta'; if (lowerVisaInfo.includes('evisa') || lowerVisaInfo.includes('pre-enrollment') || lowerVisaInfo.includes('online visa required')) return 'ev'; if (lowerVisaInfo.includes('visa required') || lowerVisaInfo.includes('visa prior to arrival')) return 'vr'; if (lowerVisaInfo.includes('not admitted')) return 'denied'; if (lowerVisaInfo.includes('citizen')) return 'citizen'; return 'na'; }
        function getBestOption(countryCode, passports) { let bestOption = { status: 'na', stay: -1, passport: null }; for (const passport of passports) { let visaInfo = allVisaData[passport]?.[countryCode] || { status: 'na', stay: 0 }; if (visaInfo.status === 'na' && visaInfo.visa) { const derivedStatus = getVisaStatusFromString(visaInfo.visa); if (derivedStatus !== 'na') { visaInfo = { ...visaInfo, status: derivedStatus }; } } const currentPriority = statusPriority[visaInfo.status]; const bestPriority = statusPriority[bestOption.status]; if (currentPriority < bestPriority) { bestOption = { ...visaInfo, passport }; } else if (currentPriority === bestPriority) { if (visaInfo.stay > bestOption.stay) { bestOption = { ...visaInfo, passport }; } } } return bestOption; }
        
        function updateMapColors() {
            if (!map || !map.isStyleLoaded()) return;

            if (currentView === 'visa') {
                const caseExpression = ['match', ['get', 'id']];
                if(selectedPassports.length === 0){
                    caseExpression.push([], '#E0E0E0');
                } else {
                    for (const countryCode in countryNameToCodeMap) {
                        const code = countryNameToCodeMap[countryCode];
                        const bestOption = getBestOption(code, selectedPassports);
                        caseExpression.push(code, statusColors[bestOption.status] || '#BDBDBD');
                    }
                }
                caseExpression.push('#BDBDBD'); // Default color
                map.setPaintProperty('countries-fill', 'fill-color', caseExpression);

            } else { // Best Passport View
                 const caseExpression = ['match', ['get', 'id']];
                 if (selectedPassports.length > 0) {
                     for (const countryCode in countryNameToCodeMap) {
                         const code = countryNameToCodeMap[countryCode];
                         if (code === 'AQ') { 
                            caseExpression.push('AQ', statusColors.na);
                            continue;
                         };
                         const bestOption = getBestOption(code, selectedPassports);
                         caseExpression.push(code, sessionPassportColors[bestOption.passport] || statusColors.na);
                     }
                 }
                 caseExpression.push('#BDBDBD'); // Default
                 map.setPaintProperty('countries-fill', 'fill-color', caseExpression);
            }
        }

        function updateLegends() { sessionPassportColors = assignPassportColors(selectedPassports); visaStatusLegend.innerHTML = ''; bestPassportLegend.innerHTML = ''; if (currentView === 'visa') { visaStatusLegend.style.display = 'flex'; bestPassportLegend.style.display = 'none'; const applicableStatuses = new Set(); if (selectedPassports.length > 0) { for (const passport of selectedPassports) { if (allVisaData[passport]) { for (const dest in allVisaData[passport]) { let status = allVisaData[passport][dest].status; if (status === 'na' && allVisaData[passport][dest].visa) { status = getVisaStatusFromString(allVisaData[passport][dest].visa); } if(status) applicableStatuses.add(status); } } } } else { Object.keys(statusText).forEach(s => applicableStatuses.add(s)); } if(selectedPassports.length > 0) { applicableStatuses.add('citizen'); } const legendGroups = {}; applicableStatuses.forEach(status => { const color = statusColors[status]; const text = statusText[status]; const priority = statusPriority[status]; if (!color || !text) return; if (!legendGroups[color]) { legendGroups[color] = { texts: new Set(), priority: priority }; } legendGroups[color].texts.add(text); }); const sortedGroups = Object.entries(legendGroups).map(([color, data]) => ({ color, texts: Array.from(data.texts), priority: data.priority })).sort((a, b) => a.priority - b.priority); sortedGroups.forEach(group => { const legendItem = document.createElement('div'); legendItem.className = 'flex items-center text-xs font-medium px-2 py-1 rounded-full whitespace-nowrap'; legendItem.style.backgroundColor = group.color; legendItem.style.color = colorConverter.isColorTooSimilar(group.color, '#FFFFFF') ? '#000000' : '#FFFFFF'; legendItem.textContent = group.texts.join(' / '); visaStatusLegend.appendChild(legendItem); }); } else { visaStatusLegend.style.display = 'none'; bestPassportLegend.style.display = 'flex'; selectedPassports.forEach((passport) => { const color = sessionPassportColors[passport]; const passportName = countryCodeToNameMap[passport] || passport; const legendItem = document.createElement('div'); legendItem.className = 'flex items-center text-xs font-medium px-2 py-1 rounded-full whitespace-nowrap'; legendItem.style.backgroundColor = color; legendItem.style.color = colorConverter.isColorTooSimilar(color, '#FFFFFF') ? '#000000' : '#FFFFFF'; legendItem.innerHTML = `<img src="https://flagcdn.com/w20/${passport.toLowerCase()}.png" class="h-4 w-6 mr-1.5 rounded-sm"> ${passportName}`; bestPassportLegend.appendChild(legendItem); }); } }
        function generateInfoContent(countryCode) { if (selectedPassports.length === 0) return '<p class="text-gray-500">Select a passport to see visa info.</p>'; if (!countryCode || !allVisaData) return '<p class="text-gray-500">No visa data available for this country.</p>'; let results = []; let lookupCode = countryCode; if (countryCode === 'GL') lookupCode = 'DK'; if (countryCode === 'PR') lookupCode = 'US'; if (countryCode === 'NC') lookupCode = 'FR'; selectedPassports.forEach(passport => { const passportName = countryCodeToNameMap[passport] || passport; let visaInfo = allVisaData[passport]?.[lookupCode] || { status: 'na', stay: 0 }; if (visaInfo.status === 'na' && visaInfo.visa) { const derivedStatus = getVisaStatusFromString(visaInfo.visa); if (derivedStatus !== 'na') { visaInfo = { ...visaInfo, status: derivedStatus }; } } results.push({ passport: passportName, status: visaInfo.status, stay: visaInfo.stay, priority: statusPriority[visaInfo.status] }); }); results.sort((a, b) => { if (a.priority !== b.priority) return a.priority - b.priority; return b.stay - a.stay; }); let contentHTML = '<ul class="space-y-2">'; results.forEach((res, index) => { const isBest = index === 0 && res.status !== 'na'; let stayText = (res.status === 'citizen') ? 'Unlimited Stay' : (res.stay > 0 ? `${res.stay} days` : ''); contentHTML += `<li class="flex items-center ${isBest ? 'font-bold' : ''}"><span class="w-3 h-3 rounded-full mr-3" style="background-color:${statusColors[res.status]}"></span><span>${res.passport}: ${statusText[res.status]} ${stayText ? `(${stayText})` : ''}</span>${isBest ? '<span class="ml-auto text-xs bg-green-100 text-green-800 font-semibold px-2 py-0.5 rounded-full">Best</span>' : ''}</li>`; }); contentHTML += '</ul>'; return contentHTML; }
        
        async function switchToMapView() { if (selectedPassports.length === 0) return; loaderText.textContent = 'Loading Visa Data...'; loader.style.display = 'flex'; await new Promise(resolve => setTimeout(resolve, 10)); loader.style.opacity = '1'; loader.style.pointerEvents = 'auto'; try { const response = await fetch('/api/visa-data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ passports: selectedPassports }) }); if (!response.ok) throw new Error(`Could not fetch visa data from server: ${response.statusText}`); allVisaData = await response.json(); const specialPermitData = { status: 'permit', stay: Infinity, visa: 'Travel Permit Required' }; if (allVisaData['HK']) { allVisaData['HK']['CN'] = { ...specialPermitData }; } if (allVisaData['MO']) { allVisaData['MO']['CN'] = { ...specialPermitData }; } if (allVisaData['CN']) { allVisaData['CN']['HK'] = { ...specialPermitData }; allVisaData['CN']['MO'] = { ...specialPermitData }; } updateLegends(); updateMapColors(); updateMapSelectedFlags(); landingPage.style.opacity = '0'; landingPage.style.pointerEvents = 'none'; mapView.style.opacity = '1'; mapView.style.pointerEvents = 'auto'; map.resize(); } catch(error) { console.error(error); alert("Failed to load visa data from the server. Please ensure the backend is running and the data file exists. See console for details."); } finally { loader.style.opacity = '0'; loader.style.pointerEvents = 'none'; setTimeout(() => { loader.style.display = 'none'; }, 500); } }
        function updateMapSelectedFlags() { mapSelectedFlags.innerHTML = ''; selectedPassports.forEach(code => { const flagImg = document.createElement('img'); flagImg.src = `https://flagcdn.com/w40/${code.toLowerCase()}.png`; flagImg.className = 'h-8 rounded-md shadow-sm'; flagImg.title = countryCodeToNameMap[code]; mapSelectedFlags.appendChild(flagImg); }); }
        function updateSelectedTray() { selectedFlagsContainer.innerHTML = ''; if (selectedPassports.length === 0) { selectedFlagsContainer.appendChild(trayPlaceholder); } else { trayPlaceholder.remove(); selectedPassports.forEach(code => { const flagImg = document.createElement('img'); flagImg.src = `https://flagcdn.com/w40/${code.toLowerCase()}.png`; flagImg.className = 'h-8 rounded-md shadow-sm cursor-pointer'; flagImg.dataset.code = code; flagImg.title = `Click to remove ${countryCodeToNameMap[code]}`; selectedFlagsContainer.appendChild(flagImg); }); } viewMapBtn.disabled = selectedPassports.length === 0; }
        function handleFlagClick(event) { const target = event.target.closest('.flag-item'); if (!target) return; const code = target.dataset.code; if (selectedPassports.includes(code)) { selectedPassports = selectedPassports.filter(p => p !== code); target.classList.remove('selected'); } else { selectedPassports.push(code); target.classList.add('selected'); } updateSelectedTray(); countrySearch.value = ''; countrySearch.dispatchEvent(new Event('input', { bubbles: true })); if (event.pointerType !== 'touch') { countrySearch.focus(); } }
        function handleTrayFlagClick(event) { const target = event.target; if (target.tagName === 'IMG') { const code = target.dataset.code; if (!code) return; selectedPassports = selectedPassports.filter(p => p !== code); const gridFlag = flagGrid.querySelector(`.flag-item[data-code="${code}"]`); if (gridFlag) { gridFlag.classList.remove('selected'); } updateSelectedTray(); } }

        // --- INITIALIZATION ---
        async function initialize() {
            loaderText.textContent = 'Initializing...';
            loader.style.display = 'flex';
            loader.style.opacity = '1';

            const passportOptions = Object.keys(apiPassportList).map(name => ({ value: apiPassportList[name], text: name })).sort((a, b) => a.text.localeCompare(b.text));
            const flagGridFragment = document.createDocumentFragment();
            passportOptions.forEach(opt => {
                const flagItem = document.createElement('div');
                flagItem.className = 'flag-item flex flex-col items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200';
                flagItem.dataset.code = opt.value;
                flagItem.dataset.name = opt.text.toLowerCase();
                flagItem.addEventListener('click', handleFlagClick);
                flagItem.innerHTML = `<img src="https://flagcdn.com/w80/${opt.value.toLowerCase()}.png" class="h-10 mb-2 shadow-md rounded" alt="${opt.text}" loading="lazy"><span class="text-xs text-center">${opt.text}</span>`;
                flagGridFragment.appendChild(flagItem);
            });
            flagGrid.appendChild(flagGridFragment);

            // Fetch Mapbox token from backend
            let mapboxToken;
            try {
                const response = await fetch('/mapbox-token');
                const data = await response.json();
                mapboxToken = data.token;
                if (!mapboxToken) throw new Error('Mapbox token not found');
            } catch (error) {
                console.error("Failed to fetch Mapbox token:", error);
                alert("Could not retrieve Mapbox token. The map cannot be loaded.");
                loader.style.display = 'none';
                return;
            }

            mapboxgl.accessToken = mapboxToken;
            map = new mapboxgl.Map({
                container: 'map-container',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [0, 20],
                zoom: 1,
                projection: 'equalEarth' // Set projection here
            });

            map.on('load', async () => {
                const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json');
                const world = await response.json();
                const geojsonData = topojson.feature(world, world.objects.countries);
                
                // Add the main countries source and layer
                map.addSource('countries', {
                    'type': 'geojson',
                    'data': geojsonData,
                    'promoteId': 'id' // Use the ISO 3166-1 alpha-2 code as the feature ID
                });

                map.addLayer({
                    'id': 'countries-fill',
                    'type': 'fill',
                    'source': 'countries',
                    'paint': {
                        'fill-color': '#E0E0E0', // Default no-passport color
                        'fill-outline-color': '#666'
                    }
                });

                map.addLayer({
                    'id': 'countries-hover',
                    'type': 'line',
                    'source': 'countries',
                    'paint': {
                        'line-color': '#333',
                        'line-width': [
                            'case',
                            ['boolean', ['feature-state', 'hover'], false],
                            2,
                            0
                        ]
                    }
                });

                // --- Mapbox Event Listeners ---
                map.on('mousemove', 'countries-fill', (e) => {
                    if (e.features.length > 0) {
                        const feature = e.features[0];
                        if (hoveredCountryId !== null) {
                            map.setFeatureState({ source: 'countries', id: hoveredCountryId }, { hover: false });
                        }
                        hoveredCountryId = feature.id;
                        map.setFeatureState({ source: 'countries', id: hoveredCountryId }, { hover: true });

                        const countryName = feature.properties.name;
                        const countryCode = feature.id;

                        tooltipCountry.textContent = countryName;
                        tooltipContent.innerHTML = generateInfoContent(countryCode);
                        tooltip.style.opacity = 1;
                        
                        const tooltipWidth = tooltip.offsetWidth;
                        const tooltipHeight = tooltip.offsetHeight;
                        const padding = 15;
                        let left = e.point.x + padding;
                        let top = e.point.y + padding;

                        if (left + tooltipWidth > map.getCanvas().clientWidth) {
                            left = e.point.x - tooltipWidth - padding;
                        }
                        if (top + tooltipHeight > map.getCanvas().clientHeight) {
                            top = e.point.y - tooltipHeight - padding;
                        }
                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';
                    }
                });

                map.on('mouseleave', 'countries-fill', () => {
                    if (hoveredCountryId !== null) {
                        map.setFeatureState({ source: 'countries', id: hoveredCountryId }, { hover: false });
                    }
                    hoveredCountryId = null;
                    tooltip.style.opacity = 0;
                });
                
                loader.style.opacity = '0';
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            });
            
            countrySearch.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase().trim(); document.querySelectorAll('.flag-item').forEach(item => { const officialName = item.dataset.name; const code = item.dataset.code; let match = officialName.startsWith(searchTerm); if (!match && countryAliases[code]) { for (const alias of countryAliases[code]) { if (alias.startsWith(searchTerm)) { match = true; break; } } } item.style.display = match ? 'flex' : 'none'; }); });
            countrySearch.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); const firstVisibleFlag = document.querySelector('.flag-item:not([style*="display: none"])'); if (firstVisibleFlag) { firstVisibleFlag.click(); } } });
            viewMapBtn.addEventListener('click', switchToMapView);
            backToLandingBtn.addEventListener('click', () => { mapView.style.opacity = '0'; mapView.style.pointerEvents = 'none'; landingPage.style.opacity = '1'; landingPage.style.pointerEvents = 'auto'; });
            visaViewBtn.addEventListener('click', () => { currentView = 'visa'; visaViewBtn.classList.add('active'); passportViewBtn.classList.remove('active'); updateLegends(); updateMapColors(); });
            passportViewBtn.addEventListener('click', () => { currentView = 'passport'; passportViewBtn.classList.add('active'); visaViewBtn.classList.remove('active'); updateLegends(); updateMapColors(); });
            selectedFlagsContainer.addEventListener('click', handleTrayFlagClick);
        }

        initialize();
    </script>
</body>
</html>
