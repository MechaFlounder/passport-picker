<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DCD81Z7V4V"></script>
	<script>
  	window.dataLayer = window.dataLayer || [];
  	function gtag(){dataLayer.push(arguments);}
  	gtag('js', new Date());

  	gtag('config', 'G-DCD81Z7V4V');
    </script>
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6081762145343306"
     	crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passport Picker - Visa-Free Travel Map</title>

    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        #loader {
            transition: opacity 0.5s ease-out;
        }
        /* Mapbox container */
        #map-container {
            width: 100%;
            height: 100%;
        }
        .mapboxgl-popup-content {
            border-radius: 8px !important;
            padding: 1rem !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .mapboxgl-popup-anchor-top .mapboxgl-popup-tip,
        .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip,
        .mapboxgl-popup-anchor-left .mapboxgl-popup-tip,
        .mapboxgl-popup-anchor-right .mapboxgl-popup-tip {
            border-color: transparent;
        }
        /* Color classes for info popups */
        .info-citizen:before { background-color: #8E44AD; }
        .info-fom:before { background-color: #81C784; }
        .info-permit:before { background-color: #3498DB; }
        .info-vf:before { background-color: #4CAF50; }
        .info-voa:before { background-color: #FFC107; }
        .info-ev:before, .info-eta:before, .info-esta:before { background-color: #2196F3; }
        .info-vr:before { background-color: #F44336; }
        .info-denied:before { background-color: #5D4037; }
        .info-na:before { background-color: #BDBDBD; }
        /* Styles for the view toggle */
        .toggle-btn.active {
            background-color: #3B82F6;
            color: white;
        }
        .toggle-btn {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        /* Styles for new flag selector */
        .flag-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .flag-item:hover {
            transform: scale(1.05);
        }
        .flag-item.selected {
            box-shadow: 0 0 0 4px #3B82F6;
            transform: scale(1.05);
        }
        /* Shake animation for passport tray */
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }
        /* Styles for toggled-off flags */
        .desaturated-flag {
            filter: grayscale(100%);
            opacity: 0.6;
            transform: scale(0.95);
        }
        #map-selected-flags img, #selected-flags-container img {
            transition: all 0.2s ease-in-out;
        }
        .legend-item.focused-legend-item {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px white, 0 0 0 4px #3B82F6;
        }
        .dragging {
            opacity: 0.4;
        }
        .drag-over-horizontal::after {
            content: '';
            display: block;
            width: 4px;
            height: 100%;
            background: #3B82F6;
            margin-left: -2px; /* Center the line */
        }
         .drag-over-vertical::after {
            content: '';
            display: block;
            height: 4px;
            width: 100%;
            background: #3B82F6;
            margin-top: -2px; /* Center the line */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased overflow-hidden">
    <div id="notification" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-all duration-300 pointer-events-none z-[11000] transform -translate-y-20">
        </div>
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-[10000]" style="display: none; opacity: 0;">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loader-text" class="mt-4 text-lg text-gray-700 font-medium">Initializing...</p>
        </div>
    </div>
    <div id="landing-page" class="h-screen w-screen bg-gray-100 overflow-hidden transition-opacity duration-500">
        <div class="text-center max-w-4xl w-full flex flex-col h-full mx-auto p-4">
            <header class="py-4 flex-shrink-0">
                <h1 class="text-5xl md:text-6xl font-bold text-gray-900">Passport Picker</h1>
                <p class="text-xl text-gray-600 mt-4">Select all of your passports. Pick your favorite one first.</p>
            </header>
            
            <div id="selected-passports-tray" class="w-full max-w-4xl my-6 flex-shrink-0">
                 <div class="bg-white rounded-lg shadow-lg p-4 flex items-center justify-between">
                     <div class="flex-grow">
                         <h3 class="text-lg font-semibold text-gray-700 mb-2 text-left">Your Passports:</h3>
                         <div id="selected-flags-container" class="flex items-center gap-3 h-12 overflow-x-auto">
                             <span id="tray-placeholder" class="text-gray-500">Select a passport to begin</span>
                         </div>
                     </div>
                     <button id="view-map-btn" class="ml-4 flex-shrink-0 bg-blue-600 text-white font-bold w-12 h-12 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                     </button>
                 </div>
            </div>
            <div class="w-full max-w-lg mx-auto mb-4 flex-shrink-0">
                <input type="text" id="country-search" placeholder="Search for a country..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div id="flag-grid" class="flex-grow overflow-y-auto grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4 p-4 bg-white rounded-lg shadow-inner w-full">
                </div>
        </div>
    </div>
    <div id="map-view" class="h-screen w-screen absolute top-0 left-0 opacity-0 pointer-events-none transition-opacity duration-500">
        <div id="map-container"></div>
        <div class="absolute top-4 left-4 z-10">
            <button id="back-to-landing-btn" class="bg-white bg-opacity-90 backdrop-blur-sm rounded-full shadow-lg p-2 hover:bg-gray-200 transition-colors">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            </button>
        </div>
        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-10">
            <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-full shadow-lg p-1 flex">
                <button id="visa-view-btn" class="toggle-btn text-sm font-semibold py-2 px-6 rounded-full">Visa Status</button>
                <button id="passport-view-btn" class="toggle-btn active text-sm font-semibold py-2 px-6 rounded-full">Best Passport</button>
            </div>
        </div>
        <div class="absolute bottom-20 sm:bottom-4 inset-x-4 sm:inset-x-auto sm:left-1/2 sm:-translate-x-1/2 sm:w-auto max-w-4xl pointer-events-auto">
            <div class="bg-transparent rounded-xl p-2">
                <div id="visa-status-legend" class="flex flex-wrap justify-center gap-x-3 gap-y-1">
                    </div>
                <div id="best-passport-legend" class="hidden flex-wrap justify-center gap-2">
                    </div>
            </div>
        </div>
        <div class="absolute top-4 right-4 pointer-events-auto">
            <div class="bg-transparent rounded-xl p-3">
                 <div id="map-selected-flags" class="flex flex-col space-y-2">
                     </div>
            </div>
        </div>
    </div>
    <script>
        // --- UI ELEMENTS ---
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const landingPage = document.getElementById('landing-page');
        const mapView = document.getElementById('map-view');
        const viewMapBtn = document.getElementById('view-map-btn');
        const backToLandingBtn = document.getElementById('back-to-landing-btn');
        const visaViewBtn = document.getElementById('visa-view-btn');
        const passportViewBtn = document.getElementById('passport-view-btn');
        const visaStatusLegend = document.getElementById('visa-status-legend');
        const bestPassportLegend = document.getElementById('best-passport-legend');
        const flagGrid = document.getElementById('flag-grid');
        const countrySearch = document.getElementById('country-search');
        const selectedFlagsContainer = document.getElementById('selected-flags-container');
        const mapSelectedFlags = document.getElementById('map-selected-flags');
        const trayPlaceholder = document.getElementById('tray-placeholder');
        const notification = document.getElementById('notification');
        
        let allVisaData = {};
        let currentView = 'passport';
        let sessionPassportColors = {};
        let selectedPassports = [];
        let activePassports = []; // Passports currently toggled on for map view
        let focusedLegend = null; // To track legend item focus
        let notificationTimeout;
        let draggedElement = null; // For drag and drop
        const fallbackColors = ['#E6194B', '#FFE119', '#F58231', '#911EB4', '#46F0F0', '#F032E6', '#BCF60C', '#FABEBE', '#008080', '#E6BEFF'];
        
        // --- DATA MAPPING & PRIORITIES ---
        const statusPriority = { "citizen": 0, "fom": 1, "permit": 2, "vf": 3, "esta": 4, "eta": 4, "ev": 4, "voa": 5, "vr": 6, "denied": 7, "na": 8 };
        const statusText = { "citizen": "Citizen", "fom": "Freedom of Movement", "permit": "Travel Permit Required", "vf": "Visa Not Required", "voa": "Visa on Arrival", "esta": "ESTA", "eta": "eTA", "ev": "e-Visa / Online", "vr": "Visa Required", "denied": "Not Admitted", "na": "No Data" };
        const statusColors = { "citizen": "#8E44AD", "fom": "#81C784", "permit": "#3498DB", "vf": "#4CAF50", "voa": "#FFC107", "esta": "#2196F3", "eta": "#2196F3", "ev": "#2196F3", "vr": "#F44336", "denied": "#5D4037", "na": "#BDBDBD", "no-passport": "#E0E0E0" };
        const TIE_COLOR = '#D8BFD8'; // New color for "All Equal" case
        const TIE_LEGEND_TEXT = 'All Equal';
        const countryColorPalette = {'US': { primary: '#0A3161', secondary: '#B31942' }, 'GB': { primary: '#CF142B', secondary: '#00247D' },'CA': { primary: '#FF0000', secondary: '#FFFFFF' }, 'AU': { primary: '#00008B', secondary: '#FFCD00' },'NZ': { primary: '#00247D', secondary: '#CF142B' }, 'DE': { primary: '#000000', secondary: '#FFCE00' },'FR': { primary: '#0055A4', secondary: '#EF4135' }, 'IT': { primary: '#009246', secondary: '#CE2B37' },'ES': { primary: '#C60B1E', secondary: '#FFC400' }, 'JP': { primary: '#BC002D', secondary: '#FFFFFF' },'CN': { primary: '#EE1C25', secondary: '#FFFF00' }, 'IN': { primary: '#FF9933', secondary: '#138808' },'BR': { primary: '#009B3A', secondary: '#FFDF00' }, 'RU': { primary: '#D52B1E', secondary: '#0039A6' },'ZA': { primary: '#007A4D', secondary: '#FFB612' }, 'IE': { primary: '#169B62', secondary: '#FF883E' },'CH': { primary: '#FF0000', secondary: '#FFFFFF' }, 'SE': { primary: '#006AA7', secondary: '#FFCD00' },'NO': { primary: '#EF2B2D', secondary: '#002868' }, 'KR': { primary: '#CD2E3A', secondary: '#0047A0' }};
        const countryAliases = {"US": ["usa", "america", "united states"],"GB": ["uk", "great britain", "england", "scotland", "wales", "britain"],"AE": ["uae"],"KR": ["south korea", "republic of korea"],"KP": ["north korea"],"RU": ["russia"],"CZ": ["czechia"],"CD": ["drc", "congo dem. rep."],"CG": ["congo"],"BS": ["the bahamas"],"DO": ["dr", "dominican rep."],"CF": ["car", "central african rep."],"ZA": ["sa"],"NZ": ["new zeland"]};
        const apiPassportList = { "Afghanistan": "AF", "Albania": "AL", "Algeria": "DZ", "Andorra": "AD", "Angola": "AO", "Antigua and Barbuda": "AG", "Argentina": "AR", "Armenia": "AM", "Australia": "AU", "Austria": "AT", "Azerbaijan": "AZ", "Bahamas": "BS", "Bahrain": "BH", "Bangladesh": "BD", "Barbados": "BB", "Belarus": "BY", "Belgium": "BE", "Belize": "BZ", "Benin": "BJ", "Bhutan": "BT", "Bolivia": "BO", "Bosnia and Herzegovina": "BA", "Botswana": "BW", "Brazil": "BR", "Brunei": "BN", "Bulgaria": "BG", "Burkina Faso": "BF", "Burundi": "BI", "Cambodia": "KH", "Cameroon": "CM", "Canada": "CA", "Cape Verde": "CV", "Central African Republic": "CF", "Chad": "TD", "Chile": "CL", "China": "CN", "Colombia": "CO", "Comoros": "KM", "Congo": "CG", "Congo (Dem. Rep.)": "CD", "Costa Rica": "CR", "Cote d'Ivoire": "CI", "Croatia": "HR", "Cuba": "CU", "Cyprus": "CY", "Czech Republic": "CZ", "Denmark": "DK", "Djibouti": "DJ", "Dominica": "DM", "Dominican Republic": "DO", "Ecuador": "EC", "Egypt": "EG", "El Salvador": "SV", "Equatorial Guinea": "GQ", "Eritrea": "ER", "Estonia": "EE", "Eswatini": "SZ", "Ethiopia": "ET", "Fiji": "FJ", "Finland": "FI", "France": "FR", "Gabon": "GA", "Gambia": "GM", "Georgia": "GE", "Germany": "DE", "Ghana": "GH", "Greece": "GR", "Grenada": "GD", "Guatemala": "GT", "Guinea": "GN", "Guinea-Bissau": "GW", "Guyana": "GY", "Haiti": "HT", "Honduras": "HN", "Hong Kong": "HK", "Hungary": "HU", "Iceland": "IS", "India": "IN", "Indonesia": "ID", "Iran": "IR", "Iraq": "IQ", "Ireland": "IE", "Israel": "IL", "Italy": "IT", "Jamaica": "JM", "Japan": "JP", "Jordan": "JO", "Kazakhstan": "KZ", "Kenya": "KE", "Kiribati": "KI", "Kosovo": "XK", "Kuwait": "KW", "Kyrgyzstan": "KG", "Laos": "LA", "Latvia": "LV", "Lebanon": "LB", "Lesotho": "LS", "Liberia": "LR", "Libya": "LY", "Liechtenstein": "LI", "Lithuania": "LT", "Luxembourg": "LU", "Macau": "MO", "Madagascar": "MG", "Malawi": "MW", "Malaysia": "MY", "Maldives": "MV", "Mali": "ML", "Malta": "MT", "Marshall Islands": "MH", "Mauritania": "MR", "Mauritius": "MU", "Mexico": "MX", "Micronesia": "FM", "Moldova": "MD", "Monaco": "MC", "Mongolia": "MN", "Montenegro": "ME", "Morocco": "MA", "Mozambique": "MZ", "Myanmar": "MM", "Namibia": "NA", "Nauru": "NR", "Nepal": "NP", "Netherlands": "NL", "New Zealand": "NZ", "Nicaragua": "NI", "Niger": "NE", "Nigeria": "NG", "North Korea": "KP", "North Macedonia": "MK", "Norway": "NO", "Oman": "OM", "Pakistan": "PK", "Palau": "PW", "Palestinian Territories": "PS", "Panama": "PA", "Papua New Guinea": "PG", "Paraguay": "PY", "Peru": "PE", "Philippines": "PH", "Poland": "PL", "Portugal": "PT", "Qatar": "QA", "Romania": "RO", "Russian Federation": "RU", "Rwanda": "RW", "Saint Kitts and Nevis": "KN", "Saint Lucia": "LC", "Samoa": "WS", "San Marino": "SM", "Sao Tome and Principe": "ST", "Saudi Arabia": "SA", "Senegal": "SN", "Serbia": "RS", "Seychelles": "SC", "Sierra Leone": "SL", "Singapore": "SG", "Slovakia": "SK", "Slovenia": "SI", "Solomon Islands": "SB", "Somalia": "SO", "South Africa": "ZA", "South Korea": "KR", "South Sudan": "SS", "Spain": "ES", "Sri Lanka": "LK", "St. Vincent and the Grenadines": "VC", "Sudan": "SD", "Suriname": "SR", "Sweden": "SE", "Switzerland": "CH", "Syria": "SY", "Taiwan": "TW", "Tajikistan": "TJ", "Tanzania": "TZ", "Thailand": "TH", "Timor-Leste": "TL", "Togo": "TG", "Tonga": "TO", "Trinidad and Tobago": "TT", "Tunisia": "TN", "Türkiye": "TR", "Turkmenistan": "TM", "Tuvalu": "TV", "Uganda": "UG", "Ukraine": "UA", "United Arab Emirates": "AE", "United Kingdom": "GB", "United States of America": "US", "Uruguay": "UY", "Uzbekistan": "UZ", "Vanuatu": "VU", "Vatican City": "VA", "Venezuela": "VE", "Viet Nam": "VN", "Yemen": "YE", "Zambia": "ZM", "Zimbabwe": "ZW" };
        const countryCodeToNameMap = {};
        for (const name in apiPassportList) { countryCodeToNameMap[apiPassportList[name]] = name; }
        const isoA3toA2 = {'AFG': 'AF', 'ALB': 'AL', 'DZA': 'DZ', 'AND': 'AD', 'AGO': 'AO', 'ATG': 'AG', 'ARG': 'AR', 'ARM': 'AM', 'AUS': 'AU', 'AUT': 'AT', 'AZE': 'AZ', 'BHS': 'BS', 'BHR': 'BH', 'BGD': 'BD', 'BRB': 'BB', 'BLR': 'BY', 'BEL': 'BE', 'BLZ': 'BZ', 'BEN': 'BJ', 'BTN': 'BT', 'BOL': 'BO', 'BIH': 'BA', 'BWA': 'BW', 'BRA': 'BR', 'BRN': 'BN', 'BGR': 'BG', 'BFA': 'BF', 'BDI': 'BI', 'KHM': 'KH', 'CMR': 'CM', 'CAN': 'CA', 'CPV': 'CV', 'CAF': 'CF', 'TCD': 'TD', 'CHL': 'CL', 'CHN': 'CN', 'COL': 'CO', 'COM': 'KM', 'COG': 'CG', 'COD': 'CD', 'CRI': 'CR', 'CIV': 'CI', 'HRV': 'HR', 'CUB': 'CU', 'CYP': 'CY', 'CZE': 'CZ', 'DNK': 'DK', 'DJI': 'DJ', 'DMA': 'DM', 'DOM': 'DO', 'ECU': 'EC', 'EGY': 'EG', 'SLV': 'SV', 'GNQ': 'GQ', 'ERI': 'ER', 'EST': 'EE', 'SWZ': 'SZ', 'ETH': 'ET', 'FJI': 'FJ', 'FIN': 'FI', 'FRA': 'FR', 'GAB': 'GA', 'GMB': 'GM', 'GEO': 'GE', 'DEU': 'DE', 'GHA': 'GH', 'GRC': 'GR', 'GRD': 'GD', 'GTM': 'GT', 'GIN': 'GN', 'GNB': 'GW', 'GUY': 'GY', 'HTI': 'HT', 'HND': 'HN', 'HKG': 'HK', 'HUN': 'HU', 'ISL': 'IS', 'IND': 'IN', 'IDN': 'ID', 'IRN': 'IR', 'IRQ': 'IQ', 'IRL': 'IE', 'ISR': 'IL', 'ITA': 'IT', 'JAM': 'JM', 'JPN': 'JP', 'JOR': 'JO', 'KAZ': 'KZ', 'KEN': 'KE', 'KIR': 'KI', 'KOS': 'XK', 'KWT': 'KW', 'KGZ': 'KG', 'LAO': 'LA', 'LVA': 'LV', 'LBN': 'LB', 'LSO': 'LS', 'LBR': 'LR', 'LBY': 'LY', 'LIE': 'LI', 'LTU': 'LT', 'LUX': 'LU', 'MAC': 'MO', 'MDG': 'MG', 'MWI': 'MW', 'MYS': 'MY', 'MDV': 'MV', 'MLI': 'ML', 'MLT': 'MT', 'MHL': 'MH', 'MRT': 'MR', 'MUS': 'MU', 'MEX': 'MX', 'FSM': 'FM', 'MDA': 'MD', 'MCO': 'MC', 'MNG': 'MN', 'MNE': 'ME', 'MAR': 'MA', 'MOZ': 'MZ', 'MMR': 'MM', 'NAM': 'NA', 'NRU': 'NR', 'NPL': 'NP', 'NLD': 'NL', 'NZL': 'NZ', 'NIC': 'NI', 'NER': 'NE', 'NGA': 'NG', 'PRK': 'KP', 'MKD': 'MK', 'NOR': 'NO', 'OMN': 'OM', 'PAK': 'PK', 'PLW': 'PW', 'PSE': 'PS', 'PAN': 'PA', 'PNG': 'PG', 'PRY': 'PY', 'PER': 'PE', 'PHL': 'PH', 'POL': 'PL', 'PRT': 'PT', 'QAT': 'QA', 'ROU': 'RO', 'RUS': 'RU', 'RWA': 'RW', 'KNA': 'KN', 'LCA': 'LC', 'WSM': 'WS', 'SMR': 'SM', 'STP': 'ST', 'SAU': 'SA', 'SEN': 'SN', 'SRB': 'RS', 'SYC': 'SC', 'SLE': 'SL', 'SGP': 'SG', 'SVK': 'SK', 'SVN': 'SI', 'SLB': 'SB', 'SOM': 'SO', 'ZAF': 'ZA', 'KOR': 'KR', 'SSD': 'SS', 'ESP': 'ES', 'LKA': 'LK', 'VCT': 'VC', 'SDN': 'SD', 'SUR': 'SR', 'SWE': 'SE', 'CHE': 'CH', 'SYR': 'SY', 'TWN': 'TW', 'TJK': 'TJ', 'TZA': 'TZ', 'THA': 'TH', 'TLS': 'TL', 'TGO': 'TG', 'TON': 'TO', 'TTO': 'TT', 'TUN': 'TN', 'TUR': 'TR', 'TKM': 'TM', 'TUV': 'TV', 'UGA': 'UG', 'UKR': 'UA', 'ARE': 'AE', 'GBR': 'GB', 'USA': 'US', 'URY': 'UY', 'UZB': 'UZ', 'VUT': 'VU', 'VAT': 'VA', 'VEN': 'VE', 'VIR': 'VI', 'VNM': 'VN', 'YEM': 'YE', 'ZMB': 'ZM', 'ZWE': 'ZW', 'ESH': 'EH', 'GRL': 'GL', 'PRI': 'PR', 'NCL': 'FR', 'SJM': 'SJ', 'FLK': 'FK'};
        
        // --- MAPBOX SETUP ---
        let map;
        let hoveredCountryId = null;
        const MAP_LAYER_ID = 'country-fills';
        const DISPUTED_LAYER_ID = 'disputed-territories-fill';
        async function initializeMap(token) {
            mapboxgl.accessToken = token;
            map = new mapboxgl.Map({
                container: 'map-container',
                style: {
                    "version": 8,
                    "name": "Blank",
                    "sources": {},
                    "layers": [
                        {
                            "id": "background",
                            "type": "background",
                            "paint": {
                                "background-color": "#f0f2f5" // A neutral light gray
                            }
                        }
                    ]
                },
                center: [0, 20],
                zoom: 1.5,
                projection: 'naturalEarth'
            });
            const popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false
            });
            map.on('load', () => {
                map.addSource('countries', {
                    'type': 'vector',
                    'url': 'mapbox://mapbox.country-boundaries-v1',
                    'worldview': 'US'
                });
                map.addLayer({
                    'id': MAP_LAYER_ID,
                    'type': 'fill',
                    'source': 'countries',
                    'source-layer': 'country_boundaries',
                    'filter': ['==', ['get', 'disputed'], 'false'],
                    'paint': {
                        'fill-color': statusColors['no-passport'],
                        'fill-opacity': 1.0
                    }
                });
                map.addLayer({
                    'id': DISPUTED_LAYER_ID,
                    'type': 'fill',
                    'source': 'countries',
                    'source-layer': 'country_boundaries',
                    'filter': ['==', ['get', 'disputed'], 'true'],
                    'paint': {
                        'fill-color': statusColors['na'],
                        'fill-opacity': 1.0
                    }
                });
                map.addLayer({
                    'id': 'country-borders-casing',
                    'type': 'line',
                    'source': 'countries',
                    'source-layer': 'country_boundaries',
                    'layout': {},
                    'paint': {
                        'line-color': '#FFFFFF',
                        'line-width': 1.5,
                        'line-opacity': 0.8
                    }
                });
                map.addLayer({
                    'id': 'country-borders',
                    'type': 'line',
                    'source': 'countries',
                    'source-layer': 'country_boundaries',
                    'layout': {},
                    'paint': {
                        'line-color': '#333333',
                        'line-width': 0.75
                    }
                });
                const interactiveLayerIds = [MAP_LAYER_ID, DISPUTED_LAYER_ID];
                const kashmirNames = ['Jammu and Kashmir', 'Azad Kashmir', 'Gilgit-Baltistan', 'Aksai Chin', 'Ladakh'];
                map.on('mousemove', interactiveLayerIds, (e) => {
                    if (e.features.length > 0) {
                        const feature = e.features[0];
                        if (hoveredCountryId !== feature.id) {
                            if (hoveredCountryId !== null) {
                                map.setFeatureState({ source: 'countries', sourceLayer: 'country_boundaries', id: hoveredCountryId }, { hover: false });
                            }
                            hoveredCountryId = feature.id;
                            map.setFeatureState({ source: 'countries', sourceLayer: 'country_boundaries', id: hoveredCountryId }, { hover: true });
                        }
                        
                        map.getCanvas().style.cursor = 'pointer';
                        
                        let countryName = feature.properties.name_en;
                        const countryCodeA3 = feature.properties.iso_3166_1_alpha_3;
                        const countryCodeA2 = isoA3toA2[countryCodeA3];
                        let contentHTML;

                        if (feature.layer.id === DISPUTED_LAYER_ID) {
                            if (countryCodeA3 === 'FLK') { countryName = 'Falkland Islands / Islas Malvinas'; } 
                            else if (kashmirNames.includes(feature.properties.name_en)) { countryName = 'Disputed Territory (Kashmir)';} 
                            else { countryName = `Disputed Territory (${feature.properties.name_en})`; }
                            contentHTML = '<p>No visa data available.</p>';
                        } else {
                            if (countryCodeA2 === 'XK') { countryName = 'Kosovo'; }
                            contentHTML = generateInfoContent(countryCodeA2);
                        }
                        const popupHTML = `<h3 class="font-bold text-lg mb-2">${countryName}</h3><div>${contentHTML}</div>`;
                        popup.setLngLat(e.lngLat).setHTML(popupHTML).addTo(map);
                    }
                });
                map.on('mouseleave', interactiveLayerIds, () => {
                    if (hoveredCountryId !== null) { map.setFeatureState({ source: 'countries', sourceLayer: 'country_boundaries', id: hoveredCountryId }, { hover: false }); }
                    hoveredCountryId = null;
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                });

                map.on('resize', () => { updateMapColors(); });
                map.on('moveend', () => { updateMapColors(); });

                loader.style.opacity = '0';
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            });
        }
        
        // --- CORE LOGIC ---
        function showNotification(message, duration = 3000) {
            if (notificationTimeout) clearTimeout(notificationTimeout);
            
            notification.textContent = message;
            notification.classList.remove('opacity-0', '-translate-y-20');
            
            notificationTimeout = setTimeout(() => {
                notification.classList.add('opacity-0', '-translate-y-20');
            }, duration);
        }
        const colorConverter = {
            isColorTooSimilar(hex1, hex2, threshold = 20) {
                if (!hex1 || !hex2) return false;
                if (hex1 === '#FFFFFF' && hex2 === '#FFFFFF') return true;
                
                const hexToRgb = (hex) => { let r = 0, g = 0, b = 0; if (hex.length == 4) { r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3]; } else if (hex.length == 7) { r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6]; } return { r: +r, g: +g, b: +b }; };
                const rgbToXyz = ({ r, g, b }) => { r /= 255; g /= 255; b /= 255; r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92; g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92; b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92; r *= 100; g *= 100; b *= 100; return { x: r * 0.4124 + g * 0.3576 + b * 0.1805, y: r * 0.2126 + g * 0.7152 + b * 0.0722, z: r * 0.0193 + g * 0.1192 + b * 0.9505 }; };
                const xyzToLab = ({ x, y, z }) => { x /= 95.047; y /= 100; z /= 108.883; x = x > 0.008856 ? Math.pow(x, 1 / 3) : (7.787 * x) + (16 / 116); y = y > 0.008856 ? Math.pow(y, 1 / 3) : (7.787 * y) + (16 / 116); z = z > 0.008856 ? Math.pow(z, 1 / 3) : (7.787 * z) + (16 / 116); return { l: (116 * y) - 16, a: 500 * (x - y), b: 200 * (y - z) }; };
                const deltaE = (labA, labB) => { const deltaL = labA.l - labB.l; const deltaA = labA.a - labB.a; const deltaB = labA.b - labB.b; const c1 = Math.sqrt(labA.a * labA.a + labA.b * labA.b); const c2 = Math.sqrt(labB.a * labB.a + labB.b * labB.b); const deltaC = c1 - c2; let deltaH = deltaA * deltaA + deltaB * deltaB - deltaC * deltaC; deltaH = deltaH < 0 ? 0 : Math.sqrt(deltaH); const sc = 1.0 + 0.045 * c1; const sh = 1.0 + 0.015 * c1; const i = (deltaL / 1.0) ** 2 + (deltaC / sc) ** 2 + (deltaH / sh) ** 2; return i < 0 ? 0 : Math.sqrt(i); };
                const lab1 = xyzToLab(rgbToXyz(hexToRgb(hex1))); const lab2 = xyzToLab(rgbToXyz(hexToRgb(hex2))); return deltaE(lab1, lab2) < threshold;
            }
        };
        function getContrastingTextColor(hex) {
            if (!hex) return '#000000';
            const cleanHex = hex.startsWith('#') ? hex.slice(1) : hex;
            if (cleanHex.length !== 6) return '#000000';
            const r = parseInt(cleanHex.slice(0, 2), 16); const g = parseInt(cleanHex.slice(2, 4), 16); const b = parseInt(cleanHex.slice(4, 6), 16);
            const getLuminance = (c) => { const srgb = c / 255; return srgb <= 0.03928 ? srgb / 12.92 : Math.pow((srgb + 0.055) / 1.055, 2.4); };
            const luminance = 0.2126 * getLuminance(r) + 0.7152 * getLuminance(g) + 0.0722 * getLuminance(b);
            return ((1 + 0.05) / (luminance + 0.05)) > ((luminance + 0.05) / (0 + 0.05)) ? '#FFFFFF' : '#000000';
        }
        function assignPassportColors(passports) {
            const assignedColors = {}; const usedColors = []; let fallbackIndex = 0;
            passports.forEach(passportCode => {
                const palette = countryColorPalette[passportCode]; let colorToAssign = null;
                if (palette && palette.primary) { if (!usedColors.some(usedColor => colorConverter.isColorTooSimilar(palette.primary, usedColor))) { colorToAssign = palette.primary; } }
                if (!colorToAssign && palette && palette.secondary) { if (!usedColors.some(usedColor => colorConverter.isColorTooSimilar(palette.secondary, usedColor))) { colorToAssign = palette.secondary; } }
                if (!colorToAssign) { do { colorToAssign = fallbackColors[fallbackIndex % fallbackColors.length]; fallbackIndex++; } while (usedColors.some(usedColor => colorConverter.isColorTooSimilar(colorToAssign, usedColor))); }
                assignedColors[passportCode] = colorToAssign; usedColors.push(colorToAssign);
            });
            return assignedColors;
        }
        
        function getVisaStatusFromString(visaInfo) {
            if (!visaInfo) return 'na';
            const lowerVisaInfo = visaInfo.toLowerCase();
            if (lowerVisaInfo.startsWith('freedom of movement')) return 'fom';
            if (lowerVisaInfo.startsWith('visa not required')) return 'vf';
            if (lowerVisaInfo.startsWith('citizen')) return 'citizen';
            if (lowerVisaInfo.includes('visa on arrival') || lowerVisaInfo.includes('e-voa') || lowerVisaInfo.includes('entry permit on arrival') || lowerVisaInfo.includes('free visa on arrival')) return 'voa';
            if (lowerVisaInfo.includes('esta')) return 'esta';
            if (lowerVisaInfo.includes('eta') || lowerVisaInfo.includes('evisitor')) return 'eta';
            if (lowerVisaInfo.includes('evisa') || lowerVisaInfo.includes('pre-enrollment') || lowerVisaInfo.includes('online visa required')) return 'ev';
            if (lowerVisaInfo.includes('visa required') || lowerVisaInfo.includes('visa prior to arrival')) return 'vr';
            if (lowerVisaInfo.includes('not admitted')) return 'denied';
            return 'na';
        }
        
        function getBestOptions(countryCode, passports) {
            const defaultResult = { status: 'na', stay: 0, tyingPassports: [], allPassportsTie: false };
            if (!passports || passports.length === 0) return { ...defaultResult, tyingPassports: [null] };
            switch(countryCode) {
                case 'AQ': case 'FO': case 'GF': case 'NC': case 'FK': return { status: 'na', stay: 0, tyingPassports: [null], allPassportsTie: true };
                case 'SJ': return { status: 'vf', stay: Infinity, tyingPassports: [null], allPassportsTie: true, visa: 'Visa Free (Svalbard Treaty)' };
                case 'PR': case 'VI': return getBestOptions('US', passports);
                case 'EH': return getBestOptions('MA', passports);
                case 'GL': const denmarkBestOption = getBestOptions('DK', passports); return (denmarkBestOption.status === 'vf' || denmarkBestOption.status === 'fom') ? denmarkBestOption : { status: 'vr', stay: 0, tyingPassports: [null], allPassportsTie: true, visa: 'Visa Required' };
            }
            const options = passports.map((passport, index) => {
                let visaInfo = allVisaData[passport]?.[countryCode] || { status: 'na', stay: 0, visa: 'No data' };
                if (visaInfo.status === 'na' && visaInfo.visa) {
                    const derivedStatus = getVisaStatusFromString(visaInfo.visa);
                    if (derivedStatus !== 'na') visaInfo = { ...visaInfo, status: derivedStatus };
                }
                return { ...visaInfo, passport, priority: statusPriority[visaInfo.status], order: index };
            });
            if (options.length === 0) return { ...defaultResult, tyingPassports: [null] };
            options.sort((a, b) => { if (a.priority !== b.priority) return a.priority - b.priority; if (a.stay !== b.stay) return b.stay - a.stay; return a.order - b.order; });
            const best = options[0];
            const tyingPassports = options.filter(opt => opt.priority === best.priority && opt.stay === best.stay).map(opt => opt.passport);
            return { status: best.status, stay: best.stay, tyingPassports: tyingPassports, allPassportsTie: tyingPassports.length === passports.length };
        }
        
        function handleLegendClick(type, value) {
            const newFocus = { type, value };
            if (focusedLegend && focusedLegend.type === newFocus.type && JSON.stringify(focusedLegend.value.sort()) === JSON.stringify(newFocus.value.sort())) {
                focusedLegend = null;
            } else {
                focusedLegend = newFocus;
            }
            updateMapColors();
            applyLegendFocus();
        }

        function applyLegendFocus() {
            document.querySelectorAll('.legend-item').forEach(item => item.classList.remove('focused-legend-item'));
            if (!focusedLegend) return;
            const focusedItem = Array.from(document.querySelectorAll('.legend-item')).find(item => {
                if (!item.dataset.legendType || item.dataset.legendType !== focusedLegend.type) return false;
                const itemValue = JSON.parse(item.dataset.legendValue);
                if (Array.isArray(itemValue) && Array.isArray(focusedLegend.value)) {
                    return JSON.stringify(itemValue.sort()) === JSON.stringify(focusedLegend.value.sort());
                }
                return false;
            });
            if (focusedItem) focusedItem.classList.add('focused-legend-item');
        }

        function updateLegends() {
            if (currentView === 'visa') {
                updateVisaStatusLegend();
            } else {
                updateBestPassportLegend();
            }
            applyLegendFocus();
        }

        function updateVisaStatusLegend() {
            visaStatusLegend.innerHTML = '';
            bestPassportLegend.innerHTML = '';
            visaStatusLegend.style.display = 'flex';
            bestPassportLegend.style.display = 'none';
            
            const passportsToConsider = activePassports;
            const applicableStatuses = new Set();
            if (passportsToConsider.length > 0) {
                Object.values(isoA3toA2).forEach(countryCodeA2 => {
                    if (countryCodeA2) applicableStatuses.add(getBestOptions(countryCodeA2, passportsToConsider).status);
                });
            }
            const legendGroups = {};
            applicableStatuses.forEach(status => {
                const color = statusColors[status], text = statusText[status], priority = statusPriority[status];
                if (!color || !text || status === 'no-passport') return;
                if (!legendGroups[color]) legendGroups[color] = { texts: new Set(), statuses: new Set(), priority: priority };
                legendGroups[color].texts.add(text);
                legendGroups[color].statuses.add(status);
            });
            const sortedGroups = Object.entries(legendGroups).map(([color, data]) => ({ color, texts: Array.from(data.texts), statuses: Array.from(data.statuses), priority: data.priority })).sort((a, b) => a.priority - b.priority);
            
            sortedGroups.forEach(group => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item text-xs font-medium px-3 py-1 rounded-full cursor-pointer transition-transform duration-200';
                legendItem.style.backgroundColor = group.color;
                legendItem.style.color = getContrastingTextColor(group.color);
                legendItem.textContent = group.texts.join(' / ');
                legendItem.dataset.legendType = 'visa';
                legendItem.dataset.legendValue = JSON.stringify(group.statuses);
                legendItem.addEventListener('click', (e) => handleLegendClick('visa', group.statuses));
                visaStatusLegend.appendChild(legendItem);
            });
        }
        
        function updateBestPassportLegend() {
            bestPassportLegend.innerHTML = '';
            visaStatusLegend.innerHTML = '';
            visaStatusLegend.style.display = 'none';
            bestPassportLegend.style.display = 'flex';
            
            const passportsToConsider = activePassports;
            let isAllEqualCasePresent = false;
            if (passportsToConsider.length > 1) {
                for (const countryCodeA2 of Object.values(isoA3toA2)) {
                    if (countryCodeA2 && getBestOptions(countryCodeA2, passportsToConsider).allPassportsTie) { isAllEqualCasePresent = true; break; }
                }
            }
            passportsToConsider.forEach((passport) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item flex items-center text-xs font-medium px-3 py-1 rounded-full cursor-pointer transition-transform duration-200';
                legendItem.style.backgroundColor = sessionPassportColors[passport];
                legendItem.style.color = getContrastingTextColor(sessionPassportColors[passport]);
                legendItem.textContent = countryCodeToNameMap[passport] || passport;
                legendItem.dataset.legendType = 'passport';
                legendItem.dataset.legendValue = JSON.stringify([passport]);
                legendItem.addEventListener('click', (e) => handleLegendClick('passport', [passport]));
                bestPassportLegend.appendChild(legendItem);
            });
            if (isAllEqualCasePresent) {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item text-xs font-medium px-3 py-1 rounded-full cursor-pointer transition-transform duration-200';
                legendItem.style.backgroundColor = TIE_COLOR;
                legendItem.style.color = getContrastingTextColor(TIE_COLOR);
                legendItem.textContent = TIE_LEGEND_TEXT;
                legendItem.dataset.legendType = 'tie';
                legendItem.dataset.legendValue = JSON.stringify([]); // Empty array signifies the 'all tie' case
                legendItem.addEventListener('click', (e) => handleLegendClick('tie', []));
                bestPassportLegend.appendChild(legendItem);
            }
        }
        
        function updateMapColors() {
            if (!map || !map.isStyleLoaded()) return;
            if (currentView === 'visa') {
                updateVisaStatusMapColors();
            } else {
                updateBestPassportMapColors();
            }
        }

        function updateVisaStatusMapColors() {
            const colorExpression = ['case'], fillOpacityExpression = ['case'], borderOpacityExpression = ['case'];
            const passportsToConsider = activePassports;
            const defaultColor = passportsToConsider.length === 0 ? statusColors['no-passport'] : statusColors['na'];
            if (passportsToConsider.length > 0) {
                Object.values(isoA3toA2).forEach(countryCodeA2 => {
                    if (!countryCodeA2) return;
                    const bestOption = getBestOptions(countryCodeA2, passportsToConsider);
                    const color = statusColors[bestOption.status] || statusColors['na'];
                    const condition = ['==', ['get', 'iso_3166_1'], countryCodeA2];
                    colorExpression.push(condition, color);
                    if (focusedLegend && focusedLegend.type === 'visa') {
                        const isHighlighted = focusedLegend.value.includes(bestOption.status);
                        fillOpacityExpression.push(condition, isHighlighted ? 1.0 : 0.1);
                        borderOpacityExpression.push(condition, isHighlighted ? 1.0 : 0.15);
                    }
                });
            }
            colorExpression.push(defaultColor);
            
            map.setPaintProperty(MAP_LAYER_ID, 'fill-pattern', null); // IMPORTANT: Clear pattern before setting color
            map.setPaintProperty(MAP_LAYER_ID, 'fill-color', colorExpression);

            if (focusedLegend && focusedLegend.type === 'visa') {
                fillOpacityExpression.push(0.1); borderOpacityExpression.push(0.15);
                map.setPaintProperty(MAP_LAYER_ID, 'fill-opacity', fillOpacityExpression);
                map.setPaintProperty(DISPUTED_LAYER_ID, 'fill-opacity', 0.1);
                map.setPaintProperty('country-borders', 'line-opacity', borderOpacityExpression);
                map.setPaintProperty('country-borders-casing', 'line-opacity', borderOpacityExpression);
            } else {
                map.setPaintProperty(MAP_LAYER_ID, 'fill-opacity', 1.0);
                map.setPaintProperty(DISPUTED_LAYER_ID, 'fill-opacity', 1.0);
                map.setPaintProperty('country-borders', 'line-opacity', 1.0);
                map.setPaintProperty('country-borders-casing', 'line-opacity', 0.8);
            }
        }

        function getCombinations(array, size) {
            const result = [];
            function combination(temp, start) {
                if (temp.length === size) { result.push([...temp]); return; }
                for (let i = start; i < array.length; i++) { temp.push(array[i]); combination(temp, i + 1); temp.pop(); }
            }
            combination([], 0);
            return result;
        }

        function pregenerateAllPatterns() {
            if (!map || selectedPassports.length < 2) return;
            for (let size = 2; size <= selectedPassports.length; size++) {
                const combinations = getCombinations(selectedPassports, size);
                combinations.forEach(combo => {
                    addTiePatternToMap(combo);
                });
            }
        }

        function addTiePatternToMap(passportCodes) {
            const sortedCodes = [...passportCodes].sort();
            const patternId = `stripes-${sortedCodes.join('-')}`;
            if (map.hasImage(patternId)) return;

            const colors = sortedCodes.map(code => sessionPassportColors[code]);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const size = 64;
            canvas.width = size; canvas.height = size;
            const stripeWidth = Math.max(2, 20 / colors.length);
            const step = stripeWidth;
            ctx.globalAlpha = 1.0;

            for (let i = -size; i < size * 2; i += step) {
                ctx.fillStyle = colors[Math.floor(Math.abs(i / step)) % colors.length];
                ctx.beginPath();
                ctx.moveTo(i, 0); ctx.lineTo(i + step, 0);
                ctx.lineTo(i - size + step, size); ctx.lineTo(i - size, size);
                ctx.closePath(); ctx.fill();
            }
            const imageData = ctx.getImageData(0, 0, size, size);
            map.addImage(patternId, imageData, { sdf: false });
        }

        function addSolidPatternToMap(color, patternId) {
            if (!map || map.hasImage(patternId)) return;
            const canvas = document.createElement('canvas');
            canvas.width = 1; canvas.height = 1;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color; ctx.fillRect(0, 0, 1, 1);
            const imageData = ctx.getImageData(0, 0, 1, 1);
            map.addImage(patternId, imageData, { sdf: false });
        }
        
        function updateBestPassportMapColors() {
            const patternExpression = ['case'];
            const fillOpacityExpression = ['case'];
            const borderOpacityExpression = ['case'];

            const passportsToConsider = activePassports;
            const countryResults = new Map();
            if (passportsToConsider.length > 0) {
                Object.values(isoA3toA2).forEach(code => {
                    if (code) countryResults.set(code, getBestOptions(code, passportsToConsider));
                });
            }

            countryResults.forEach((result, countryCode) => {
                const condition = ['==', ['get', 'iso_3166_1'], countryCode];
                let isCountryHighlighted = !focusedLegend || (focusedLegend.type === 'tie' ? result.allPassportsTie : (focusedLegend.type === 'passport' ? result.tyingPassports.some(p => focusedLegend.value.includes(p)) : false));
                
                if (result.tyingPassports.length === 1 && result.tyingPassports[0]) {
                    patternExpression.push(condition, `solid-${result.tyingPassports[0]}`);
                } else if (result.allPassportsTie) {
                    patternExpression.push(condition, 'solid-tie');
                } else if (result.tyingPassports.length > 1) {
                    const patternId = `stripes-${[...result.tyingPassports].sort().join('-')}`;
                    patternExpression.push(condition, patternId);
                } else {
                    patternExpression.push(condition, 'solid-na');
                }

                fillOpacityExpression.push(condition, isCountryHighlighted ? 1.0 : 0.1);
                borderOpacityExpression.push(condition, isCountryHighlighted ? 1.0 : 0.15);
            });

            patternExpression.push('solid-no-passport');
            
            map.setPaintProperty(MAP_LAYER_ID, 'fill-color', 'rgba(0,0,0,0)');
            map.setPaintProperty(MAP_LAYER_ID, 'fill-pattern', patternExpression);

            if (focusedLegend && (focusedLegend.type === 'passport' || focusedLegend.type === 'tie')) {
                fillOpacityExpression.push(0.1);
                borderOpacityExpression.push(0.15);
                map.setPaintProperty(MAP_LAYER_ID, 'fill-opacity', fillOpacityExpression);
                map.setPaintProperty(DISPUTED_LAYER_ID, 'fill-opacity', 0.1);
                map.setPaintProperty('country-borders', 'line-opacity', borderOpacityExpression);
                map.setPaintProperty('country-borders-casing', 'line-opacity', borderOpacityExpression);
            } else {
                map.setPaintProperty(MAP_LAYER_ID, 'fill-opacity', 1.0);
                map.setPaintProperty(DISPUTED_LAYER_ID, 'fill-opacity', 1.0);
                map.setPaintProperty('country-borders', 'line-opacity', 1.0);
                map.setPaintProperty('country-borders-casing', 'line-opacity', 0.8);
            }
        }

        function generateInfoContent(countryCodeA2) {
            const passportsToConsider = activePassports;
            if (passportsToConsider.length === 0) return '<p class="text-gray-500">Select a passport to see visa info.</p>';
            if (!countryCodeA2 || !allVisaData) return '<p class="text-gray-500">No visa data available for this country.</p>';
            let contentHTML = '', results = [], lookupCode = countryCodeA2, specialNote = '';
            switch(countryCodeA2) {
                case 'SJ': return '<p>Visa Free for all nationalities (Svalbard Treaty).</p>';
                case 'FK': case 'AQ': case 'FO': case 'GF': case 'NC': return '<p>No visa data available.</p>';
                case 'PR': case 'VI': lookupCode = 'US'; specialNote = `<p class="text-xs text-gray-600 pb-2 border-b mb-2">Policy follows United States.</p>`; break;
                case 'EH': lookupCode = 'MA'; specialNote = `<p class="text-xs text-gray-600 pb-2 border-b mb-2">Policy follows Morocco.</p>`; break;
                case 'GL': const denmarkBestOption = getBestOptions('DK', passportsToConsider); specialNote = `<p class="text-xs text-gray-600 pb-2 border-b mb-2">Policy follows Denmark for visa-free travel.</p>`; if (denmarkBestOption.status !== 'vf' && denmarkBestOption.status !== 'fom') return specialNote + `<ul class="space-y-2"><li><span class="w-3 h-3 rounded-full mr-3 info-vr" style="display: inline-block; vertical-align: middle;"></span><span>Visa Required</span></li></ul>`; lookupCode = 'DK'; break;
            }
            passportsToConsider.forEach(passport => {
                const passportName = countryCodeToNameMap[passport] || passport;
                let visaInfo = allVisaData[passport]?.[lookupCode] || { status: 'na', stay: 0 };
                if (visaInfo.status === 'na' && visaInfo.visa) { const derivedStatus = getVisaStatusFromString(visaInfo.visa); if (derivedStatus !== 'na') visaInfo = { ...visaInfo, status: derivedStatus }; }
                results.push({ passport: passportName, status: visaInfo.status, stay: visaInfo.stay, priority: statusPriority[visaInfo.status] });
            });
            results.sort((a, b) => { if (a.priority !== b.priority) return a.priority - b.priority; return b.stay - a.stay; });
            contentHTML += specialNote + '<ul class="space-y-2">';
            const bestPriority = results.length > 0 ? results[0].priority : 99, bestStay = results.length > 0 ? results[0].stay : 0;
            results.forEach(res => {
                const isBest = res.priority === bestPriority && res.stay === bestStay && res.status !== 'na';
                let stayText = (res.status === 'citizen') ? 'Unlimited Stay' : (res.stay > 0 ? `${res.stay} days` : '');
                contentHTML += `<li class="flex items-center ${isBest ? 'font-bold' : ''}"><span class="w-3 h-3 rounded-full mr-3 info-${res.status}" style="display: inline-block; vertical-align: middle;"></span><span>${res.passport}: ${statusText[res.status]} ${stayText ? `(${stayText})` : ''}</span>${isBest ? '<span class="ml-auto text-xs bg-green-100 text-green-800 font-semibold px-2 py-0.5 rounded-full">Best</span>' : ''}</li>`;
            });
            return contentHTML + '</ul>';
        }

        async function switchToMapView() {
    if (selectedPassports.length === 0) return;

    // --- New Tip Logic ---
    const tips = [
        "Try selecting legend items to emphasize them on the map.",
        "Select and deselect flags on the map to see what each passport contributes.",
	"Switch to the 'Visa Status' view to see your overall travel freedom",
        "Switch to the 'Best Passport' view to see which of your passports is optimal for each country."
    ];
    const randomTip = tips[Math.floor(Math.random() * tips.length)];
    loaderText.innerHTML = `Loading Visa Data...<br><span class="text-base font-normal text-gray-600 mt-2 block">Tip: ${randomTip}</span>`;
    // --- End Tip Logic ---

    loader.style.display = 'flex';
    await new Promise(resolve => setTimeout(resolve, 10));
    loader.style.opacity = '1';
    loader.style.pointerEvents = 'auto';

    try {
        // --- New Minimum Display Time Logic ---
        const minDisplayTime = new Promise(resolve => setTimeout(resolve, 2500)); // 2.5 seconds
        const fetchVisaData = fetch('/api/visa-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ passports: selectedPassports })
        });

        const [_, response] = await Promise.all([minDisplayTime, fetchVisaData]);
        // --- End Minimum Display Time Logic ---

        if (!response.ok) throw new Error(`Could not fetch visa data from server: ${response.statusText}`);
        allVisaData = await response.json();
                
                const specialPermitData = { status: 'permit', stay: Infinity, visa: 'Travel Permit Required' };
                if (allVisaData['HK']) allVisaData['HK']['CN'] = { ...specialPermitData };
                if (allVisaData['MO']) allVisaData['MO']['CN'] = { ...specialPermitData };
                if (allVisaData['CN']) {
                    allVisaData['CN']['HK'] = { ...specialPermitData };
                    allVisaData['CN']['MO'] = { ...specialPermitData };
                }
                
                sessionPassportColors = assignPassportColors(selectedPassports);

                // Pregenerate all necessary patterns for the Best Passport map
                for (const code in sessionPassportColors) { addSolidPatternToMap(sessionPassportColors[code], `solid-${code}`); }
                addSolidPatternToMap(TIE_COLOR, 'solid-tie');
                addSolidPatternToMap(statusColors['na'], 'solid-na');
                addSolidPatternToMap(statusColors['no-passport'], 'solid-no-passport');
                pregenerateAllPatterns();
                
                resetMapFocus();
                updateMapSelectedFlags();
                landingPage.style.opacity = '0';
                landingPage.style.pointerEvents = 'none';
                mapView.style.opacity = '1';
                mapView.style.pointerEvents = 'auto';
                
                if (map) map.resize();
            } catch(error) {
                console.error(error);
                alert("Failed to load visa data from the server. See console for details.");
            } finally {
                loader.style.opacity = '0';
                loader.style.pointerEvents = 'none';
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            }
        }
        
        function updateActiveFlagsUI() {
            const flags = mapSelectedFlags.querySelectorAll('img');
            flags.forEach(flag => {
                const code = flag.dataset.code;
                if (activePassports.includes(code)) {
                    flag.classList.remove('desaturated-flag');
                } else {
                    flag.classList.add('desaturated-flag');
                }
            });
        }
        function updateMapSelectedFlags() {
            mapSelectedFlags.innerHTML = '';
            selectedPassports.forEach(code => {
                const flagImg = document.createElement('img');
                flagImg.src = `https://flagcdn.com/w40/${code.toLowerCase()}.png`;
                flagImg.className = 'h-8 rounded-md shadow-sm cursor-pointer';
                flagImg.dataset.code = code;
                flagImg.title = countryCodeToNameMap[code];
                flagImg.draggable = true;
                mapSelectedFlags.appendChild(flagImg);
            });
            updateActiveFlagsUI();
        }
        function updateSelectedTray() {
            selectedFlagsContainer.innerHTML = '';
            if (selectedPassports.length === 0) { selectedFlagsContainer.appendChild(trayPlaceholder); } 
            else {
                trayPlaceholder.remove();
                selectedPassports.forEach(code => {
                    const flagImg = document.createElement('img');
                    flagImg.src = `https://flagcdn.com/w40/${code.toLowerCase()}.png`;
                    flagImg.className = 'h-8 rounded-md shadow-sm cursor-pointer';
                    flagImg.dataset.code = code;
                    flagImg.title = `Click to remove ${countryCodeToNameMap[code]}`;
                    flagImg.draggable = true;
                    selectedFlagsContainer.appendChild(flagImg);
                });
            }
            viewMapBtn.disabled = selectedPassports.length === 0;
        }
        function handleFlagClick(event) {
            const target = event.target.closest('.flag-item');
            if (!target) return;
            const code = target.dataset.code;
            if (selectedPassports.includes(code)) {
                selectedPassports = selectedPassports.filter(p => p !== code);
                target.classList.remove('selected');
            } else {
                if (selectedPassports.length >= 8) {
                    showNotification('Maximum of 8 passports can be selected.');
                    const tray = document.getElementById('selected-passports-tray');
                    tray.classList.add('shake');
                    setTimeout(() => tray.classList.remove('shake'), 820);
                    return;
                }
                selectedPassports.push(code);
                target.classList.add('selected');
            }
            updateSelectedTray();
            countrySearch.value = '';
            countrySearch.dispatchEvent(new Event('input', { bubbles: true }));
            if (event.pointerType !== 'touch') { countrySearch.focus(); }
        }
        function handleTrayFlagClick(event) {
            const target = event.target;
            if (target.tagName === 'IMG') {
                const code = target.dataset.code;
                if (!code) return;
                selectedPassports = selectedPassports.filter(p => p !== code);
                const gridFlag = flagGrid.querySelector(`.flag-item[data-code="${code}"]`);
                if (gridFlag) { gridFlag.classList.remove('selected'); }
                updateSelectedTray();
            }
        }
        function handleMapFlagClick(event) {
            const target = event.target;
            if (target.tagName !== 'IMG' || !target.dataset.code) return;
            
            const code = target.dataset.code;
            const activeSet = new Set(activePassports);
            if (activeSet.has(code)) {
                if (activeSet.size === 1) { showNotification('At least one passport must be active.'); return; }
                activeSet.delete(code);
            } else {
                activeSet.add(code);
            }
            
            activePassports = selectedPassports.filter(p => activeSet.has(p));
            
            resetMapFocus();
        }
        function resetMapFocus() {
            focusedLegend = null; // Clear legend focus when toggling flags or views
            updateActiveFlagsUI();
            updateLegends();
            updateMapColors();
        }
        function handleDragStart(e) { if (e.target.tagName === 'IMG') { draggedElement = e.target; draggedElement.classList.add('dragging'); } }
        function handleDragEnd(e) { if (draggedElement) { draggedElement.classList.remove('dragging'); } draggedElement = null; }
        function handleDragOver(e) {
            e.preventDefault();
            const container = e.currentTarget;
            const afterElement = getDragAfterElement(container, e.clientX, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (draggable) { if (afterElement == null) container.appendChild(draggable); else container.insertBefore(draggable, afterElement); }
        }
        function getDragAfterElement(container, x, y) {
            const draggableElements = [...container.querySelectorAll('img:not(.dragging)')];
            const isHorizontal = container.id === 'selected-flags-container';
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = isHorizontal ? (x - box.left - box.width / 2) : (y - box.top - box.height / 2);
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        function handleDrop(e) {
            e.preventDefault();
            const newOrder = [...e.currentTarget.querySelectorAll('img')].map(img => img.dataset.code);
            selectedPassports = newOrder;
            
            const currentActiveSet = new Set(activePassports);
            activePassports = selectedPassports.filter(p => currentActiveSet.has(p));
            
            if (mapView.style.opacity === '1') {
                // Regenerate patterns if needed and update map
                sessionPassportColors = assignPassportColors(selectedPassports);
                pregenerateAllPatterns();
                resetMapFocus();
            }
        }
        
        function handleTouchStart(e) { if (e.target.tagName === 'IMG') { draggedElement = e.target; draggedElement.classList.add('dragging'); } }
        function handleTouchMove(e) { if (!draggedElement) return; e.preventDefault(); const touch = e.touches[0]; const container = draggedElement.parentElement; const afterElement = getDragAfterElement(container, touch.clientX, touch.clientY); if (afterElement == null) container.appendChild(draggedElement); else container.insertBefore(draggedElement, afterElement); }
        function handleTouchEnd(e) { if (!draggedElement) return; const container = draggedElement.parentElement; handleDrop({ preventDefault: () => {}, currentTarget: container }); draggedElement.classList.remove('dragging'); draggedElement = null; }
        
        // --- INITIALIZATION ---
        async function initialize() {
            loaderText.textContent = 'Initializing Map...';
            loader.style.display = 'flex';
            loader.style.opacity = '1';
            const passportOptions = Object.keys(apiPassportList).map(name => ({ value: apiPassportList[name], text: name })).sort((a, b) => a.text.localeCompare(b.text));
            passportOptions.forEach(opt => {
                const flagItem = document.createElement('div');
                flagItem.className = 'flag-item flex flex-col items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200';
                flagItem.dataset.code = opt.value;
                flagItem.dataset.name = opt.text.toLowerCase();
                flagItem.addEventListener('click', handleFlagClick);
                flagItem.innerHTML = `<img src="https://flagcdn.com/w80/${opt.value.toLowerCase()}.png" class="h-10 mb-2 shadow-md rounded" alt="${opt.text}"><span class="text-xs text-center">${opt.text}</span>`;
                flagGrid.appendChild(flagItem);
            });
            
            countrySearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                document.querySelectorAll('.flag-item').forEach(item => {
                    const officialName = item.dataset.name; const code = item.dataset.code;
                    let match = officialName.startsWith(searchTerm) || (countryAliases[code] && countryAliases[code].some(alias => alias.startsWith(searchTerm)));
                    item.style.display = match ? 'flex' : 'none';
                });
            });
            countrySearch.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); const firstVisibleFlag = document.querySelector('.flag-item:not([style*="display: none"])'); if (firstVisibleFlag) { firstVisibleFlag.click(); } } });
            
            viewMapBtn.addEventListener('click', () => { activePassports = [...selectedPassports]; switchToMapView(); });
            backToLandingBtn.addEventListener('click', () => { mapView.style.opacity = '0'; mapView.style.pointerEvents = 'none'; landingPage.style.opacity = '1'; landingPage.style.pointerEvents = 'auto'; });
            
            visaViewBtn.addEventListener('click', () => {
                 currentView = 'visa';
                 visaViewBtn.classList.add('active');
                 passportViewBtn.classList.remove('active');
                 resetMapFocus();
                 map.resize();
            });
            passportViewBtn.addEventListener('click', () => {
                 currentView = 'passport';
                 passportViewBtn.classList.add('active');
                 visaViewBtn.classList.remove('active');
                 resetMapFocus();
                 map.resize();
             });

            selectedFlagsContainer.addEventListener('click', handleTrayFlagClick);
            mapSelectedFlags.addEventListener('click', handleMapFlagClick);
            
            [selectedFlagsContainer, mapSelectedFlags].forEach(container => {
                container.addEventListener('dragstart', handleDragStart); container.addEventListener('dragend', handleDragEnd); container.addEventListener('dragover', handleDragOver); container.addEventListener('drop', handleDrop);
                container.addEventListener('touchstart', handleTouchStart, {passive: false}); container.addEventListener('touchmove', handleTouchMove, {passive: false}); container.addEventListener('touchend', handleTouchEnd);
            });
            
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible' && map && mapView.style.opacity === '1') { map.resize(); updateMapColors(); } });
            
            try {
                const response = await fetch('/api/mapbox-token');
                if (!response.ok) throw new Error('Failed to fetch Mapbox token.');
                const { token } = await response.json();
                await initializeMap(token);
            } catch (error) {
                console.error("Map initialization failed:", error);
                alert("Could not initialize the map. A Mapbox token is required. Please check the backend configuration.");
                loaderText.textContent = 'Error loading map.';
            }
        }
        initialize();
    </script>
</body>
</html>